version: 0.2

env:
  parameter-store:
    AWS_DEFAULT_REGION: "/Prod/DokugakuEngineer/Api/AWS_DEFAULT_REGION"
    AWS_NGINX_REPOSITORY_URI: "/Prod/DokugakuEngineer/Api/AWS_NGINX_REPOSITORY_URI"
    AWS_API_REPOSITORY_URI: "/Prod/DokugakuEngineer/Api/AWS_API_REPOSITORY_URI"

phases:
  install:
    runtime-versions:
      docker: 18
  build:
    commands:
      - echo Building the Docker images...
      - docker-compose build api db
      - echo Running the Docker containers...
      - docker-compose up -d api
      - echo Migrating database...
      - docker-compose exec api php artisan migrate --env=testing
  post_build:
    commands:
      - echo Running PHPStan...
      - docker-compose exec api composer phpstan
      - echo Running phpcs...
      - docker-compose exec api composer phpcs
      - echo Running phpunit...
      - docker-compose exec api ./vendor/bin/phpunit
